job "paperless" {
  datacenters = ["dc1"]
  type        = "service"

  group "paperless" {
    count = 1

    network {
      mode = "host"
      port "web" {
        to = 8000
        static = 8000
      }
    }

    service {
        provider = "nomad" 
        name = "paperless"
        port = "web"
        address_mode = "host"

        tags = [
            "traefik.enable=true",
            "traefik.http.routers.paperless.rule=Host(`${hostname}`)",
            "traefik.http.routers.paperless.entrypoints=websecure",
            "traefik.http.routers.paperless.tls.certresolver=my-resolver"
        ]

        check {
            type     = "http"
            path     = "/"
            interval = "10s"
            timeout  = "2s"
        }
    }

    task "webserver" {
      driver = "podman"

      config {
        privileged = true
        image = "ghcr.io/paperless-ngx/paperless-ngx:${version}"
        ports = ["web"]
        network_mode = "host"
         
        volumes = [
          "/mnt/nas/paperless/data:/usr/src/paperless/data",
          "/mnt/nas/paperless/media:/usr/src/paperless/media",
          "/mnt/nas/paperless/export:/usr/src/paperless/export",
          "/mnt/postkorb:/usr/src/paperless/consume"
        ]
      }

      vault {
        change_mode = "restart"
      }

      template {
      data = <<EOF
{{with secret "kv/data/default/paperless/config"}}
PAPERLESS_SECRET_KEY={{.Data.data.secret_key}}
PAPERLESS_ADMIN_USER={{.Data.data.admin_user}}
PAPERLESS_ADMIN_PASSWORD={{.Data.data.admin_password}}
{{end}}
PAPERLESS_URL="http://{{ env "NOMAD_ADDR_web" }}"
PAPERLESS_TIME_ZONE="Europe/Berlin"
PAPERLESS_OCR_LANGUAGE="deu"
PAPERLESS_URL=https://${hostname}
PAPERLESS_CONSUMER_POLLING=60
USERMAP_UID=0
USERMAP_GID=0
#USERMAP_UID=258047
#USERMAP_GID=65536
EOF

        destination = "secrets/env"
        env         = true
      }

      template {
data = <<EOF
{{ with secret "database/creds/paperless" }}
PAPERLESS_DBUSER="{{ .Data.username }}"
PAPERLESS_DBPASS="{{ .Data.password }}"
{{ end }}
PAPERLESS_DBHOST="localhost"
PAPERLESS_DBPORT="5432"
PAPERLESS_DBNAME="paperless"
PAPERLESS_REDIS="redis://localhost:6379/1"
EOF
        destination = "secrets/db.env"
        env = true
      }


      resources {
        cpu    = 2000
        memory = 2048
      }
    }

  }
}