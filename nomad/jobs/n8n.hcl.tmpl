job "n8n" {
  datacenters = ["dc1"]
  type = "service"

  group "n8n-main" {
    count = 1

   network {
     mode = "host"
     port "http" {
       to     = 5678
       static = 5678
     }
     port "task" {
       to = 5679
       static = 5679
     }
      port "health" {
        to = 5680
        static = 5680
      }
   }

    task "n8n" {
      driver = "podman"

      config {
        privileged = false
        image = "docker.io/n8nio/n8n:${version}"
        ports = ["http"]
        network_mode = "host"
        volumes = [
          "/mnt/nas/n8n/data:/home/node/.n8n",
        ]
      }

      vault {
        change_mode = "restart"
      }

      template {
      data = <<EOF
{{with secret "kv/data/default/n8n/config"}}
N8N_ENCRYPTION_KEY = {{.Data.data.encryption_key}}
{{end}}
N8N_HOST = "${hostname}"
N8N_PORT = {{ env "NOMAD_PORT_http" }}
N8N_RUNNERS_BROKER_PORT = {{ env "NOMAD_PORT_task" }}
N8N_PROTOCOL = "https"
WEBHOOK_URL = "https://${hostname}/"
GENERIC_TIMEZONE = "Europe/Berlin"
NODE_TLS_REJECT_UNAUTHORIZED = "0"
# Queue mode
EXECUTIONS_MODE=queue
OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
# Redis (shared redis job)
QUEUE_BULL_REDIS_HOST=localhost
QUEUE_BULL_REDIS_PORT=6379
QUEUE_BULL_REDIS_DB=2
QUEUE_BULL_REDIS_TIMEOUT_THRESHOLD=10000
# Queue health check (main exposes health on same HTTP port)
QUEUE_HEALTH_CHECK_ACTIVE=true
QUEUE_HEALTH_CHECK_PORT={{ env "NOMAD_PORT_health" }}
EOF

        destination = "secrets/env"
        env         = true
      }

      template {
data = <<EOF
{{ with secret "database/creds/n8n" }}
DB_USER="{{ .Data.username }}"
DB_PASSWORD="{{ .Data.password }}"
{{ end }}
DB_TYPE              = "postgresdb"
DB_POSTGRESDB_HOST   = "localhost"
DB_POSTGRESDB_PORT   = "5432"
DB_POSTGRESDB_DATABASE = "n8n"
EOF
        destination = "secrets/db.env"
        env = true
      }

      resources {
        cpu    = 1000
        memory = 1024
      }

      service {
  	    provider = "nomad" 
        name = "n8n"
        port = "http"
        address_mode = "host"

        tags = [
          "traefik.enable=true",
          "traefik.http.routers.n8n.rule=Host(`${hostname}`)",
          "traefik.http.routers.n8n.entrypoints=websecure",
          "traefik.http.routers.n8n.tls.certresolver=my-resolver"
        ]

        check {
          type     = "http"
          path     = "/healthz"
          interval = "10s"
          timeout  = "2s"
        }
      }
    }
  }

  # Worker group: executes workflows from Redis queue
  group "n8n-workers" {
    count = 2

    network {
      mode = "host"

      port "task" {
        # to = 5690
        # static = 5690
      }
      port "health" {
        # to = 5691
        # static = 5691
      }

    }

    task "n8n-worker" {
      driver = "podman"

      config {
        privileged   = false
        image        = "docker.io/n8nio/n8n:${version}"
        ports        = ["health"]
        network_mode = "host"
        # Workers do not need the editor data volume
        args = ["worker"]
      }

      vault {
        change_mode = "restart"
      }

      # Core shared config + worker-specific queue settings
      template {
        data = <<EOF
{{with secret "kv/data/default/n8n/config"}}
N8N_ENCRYPTION_KEY={{.Data.data.encryption_key}}
{{end}}
GENERIC_TIMEZONE=Europe/Berlin
N8N_RUNNERS_BROKER_PORT={{ env "NOMAD_PORT_task" }}
# Queue mode worker
EXECUTIONS_MODE=queue
QUEUE_WORKER_CONCURRENCY=10
# Redis (same as main)
QUEUE_BULL_REDIS_HOST=localhost
QUEUE_BULL_REDIS_PORT=6379
QUEUE_BULL_REDIS_DB=2
QUEUE_BULL_REDIS_TIMEOUT_THRESHOLD=10000
# Worker health check on dynamic port
QUEUE_HEALTH_CHECK_ACTIVE=true
QUEUE_HEALTH_CHECK_PORT={{ env "NOMAD_PORT_health" }}
EOF
        destination = "secrets/env"
        env         = true
      }

      # Same Postgres as main
      template {
        data = <<EOF
{{ with secret "database/creds/n8n" }}
DB_USER="{{ .Data.username }}"
DB_PASSWORD="{{ .Data.password }}"
{{ end }}
DB_TYPE              = "postgresdb"
DB_POSTGRESDB_HOST   = "localhost"
DB_POSTGRESDB_PORT   = "5432"
DB_POSTGRESDB_DATABASE = "n8n"
EOF
        destination = "secrets/db.env"
        env         = true
      }

      resources {
        cpu    = 1000
        memory = 1024
      }

      service {
        provider     = "nomad"
        name         = "n8n-worker"
        port         = "health"
        address_mode = "host"

        check {
          type     = "http"
          path     = "/healthz"
          interval = "10s"
          timeout  = "2s"
        }
      }
    }
  }

}